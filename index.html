<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NYL Lead Intelligence — Modern</title>
  <meta name="description" content="Lead intelligence dashboard with multi‑source scanning and compliant public-data enrichment." />
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config={theme:{extend:{fontFamily:{sans:["Inter","-apple-system","BlinkMacSystemFont","Segoe UI","Roboto","Helvetica","Arial","sans-serif"]},colors:{ink:{50:'#f8fafc',100:'#f1f5f9',200:'#e2e8f0',300:'#cbd5e1',400:'#94a3b8',500:'#64748b',600:'#475569',700:'#334155',800:'#1e293b',900:'#0f172a'},brand:{50:'#eef2ff',100:'#e0e7ff',200:'#c7d2fe',300:'#a5b4fc',400:'#818cf8',500:'#6366f1',600:'#4f46e5',700:'#4338ca',800:'#3730a3',900:'#312e81'}}}}}</script>
  <style>html,body{height:100%} body{background:radial-gradient(1200px 800px at 10% -10%, #eff6ff 0%, transparent 60%), radial-gradient(1200px 800px at 110% 10%, #f5f3ff 0%, transparent 60%), linear-gradient(160deg,#fafafa, #f8fafc);} .glass{backdrop-filter:saturate(180%) blur(16px); background:rgba(255,255,255,.7);} .card{background:#fff;border:1px solid rgba(15,23,42,.06);box-shadow:0 1px 2px rgba(2,6,23,.06);border-radius:16px} .btn{display:inline-flex;align-items:center;gap:.5rem;border-radius:12px;padding:.65rem 1rem;font-weight:600} .btn[disabled]{opacity:.5;cursor:not-allowed} .btn-primary{background:#111827;color:#fff} .btn-primary:hover{background:#0b1220} .btn-cta{background:#4f46e5;color:#fff} .btn-cta:hover{background:#4338ca} .badge{display:inline-flex;align-items:center;gap:.35rem;border-radius:999px;border:1px solid currentColor;padding:.15rem .5rem;font-size:.725rem;font-weight:700} .shadow-soft{box-shadow:0 10px 30px rgba(15,23,42,.06),0 2px 8px rgba(15,23,42,.04)} .skeleton{background:linear-gradient(90deg, rgba(148,163,184,.18), rgba(148,163,184,.08) 40%, rgba(148,163,184,.18));background-size:200% 100%;animation:shimmer 1.6s infinite} @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}</style>
</head>
<body class="font-sans text-ink-800">
  <div id="app" class="min-h-screen"></div>

  <script type="module">
    // =====================
    // Config & constants
    // =====================
    const CONFIG = {
      APP_NAME: 'NYL Lead Intelligence',
      AGENT_NAME: 'Carnell Lake',
      AGENT_EMAIL: 'clake02@ft.newyorklife.com',
      AGENT_LICENSE: 'CA License #4423063',
      DEFAULT_REGION: 'Orange County',
      DEMO_MODE: false // set true for local/dev preview
    };

    const REGIONS = ['Orange County','Los Angeles County','San Diego County','Santa Clara County','Sacramento County','Riverside County'];

    const API_SOURCES = [
      { id:'places',       label:'Google Places',        endpoint:'places-search',        needsKey:true },
      { id:'eventbrite',   label:'Eventbrite',           endpoint:'eventbrite-search',    needsKey:true },
      { id:'ticketmaster', label:'Ticketmaster',         endpoint:'ticketmaster',         needsKey:true },
      { id:'seatgeek',     label:'SeatGeek',             endpoint:'seatgeek',            needsKey:true },
      { id:'yelp',         label:'Yelp Hot & New',       endpoint:'yelp',                needsKey:true },
      { id:'lapermits',    label:'LA City Permits',      endpoint:'la-permits',          needsKey:false },
      { id:'lacity',       label:'LA City Businesses',   endpoint:'lacity-businesses',   needsKey:false },
    ];

    // Optional CSV sources — you can add via Settings UI at runtime
    let CSV_SOURCES = [];

    // Scoring & filters
    const scoreWeights = { life: .35, quality: .25, compliance:.20, behavior:.15, geo:.05 };

    // =====================
    // State
    // =====================
    const state = {
      region: localStorage.getItem('region') || CONFIG.DEFAULT_REGION,
      items: [],
      isScanning: false,
      apiStatus: { ok:false },
      filters: { source:'all', priority:'all', sort:'score_desc', search:'' },
      demo: CONFIG.DEMO_MODE,
      notices: [],
      connectedCount: 0,
    };

    // =====================
    // Helpers
    // =====================
    const $ = (sel,root=document) => root.querySelector(sel);
    const $$ = (sel,root=document) => Array.from(root.querySelectorAll(sel));
    const fmtDate = (d) => new Date(d).toLocaleDateString();
    const pushNotice = (type,msg) => { state.notices.unshift({id:Date.now()+Math.random(),type,msg,at:new Date()}); state.notices = state.notices.slice(0,5); render(); };
    const dedupe = (arr) => {
      const map = new Map();
      for (const o of arr) {
        const key = (o.name||'').toLowerCase().trim()+ '|' + (o.location||'').slice(0,20);
        if (!map.has(key)) map.set(key,o);
      }
      return [...map.values()];
    };

    function calculateScore(lead){
      let s=0;
      const tr=lead.triggers||[]; let ts=0;
      if(tr.includes('business_formation')||tr.includes('new_registration')||tr.includes('public_record')) ts+=50;
      if(tr.includes('new_business')) ts+=45;
      if(tr.includes('property_development')) ts+=40;
      if(tr.includes('property_purchase')) ts+=45;
      if(tr.includes('family_event')) ts+=40;
      if(tr.includes('executive_change')) ts+=35;
      if(tr.includes('event_attendance')) ts+=30;
      s+=Math.min(ts,100)*scoreWeights.life;

      const qScore = {eventbrite:90, places:80, ticketmaster:85, seatgeek:85, yelp:88, lapermits:82, lacity:85, csv:70, demo:75}[lead.apiSource]||60;
      let dq=qScore; const ageH=Math.abs(Date.now()-new Date(lead.capturedAt||Date.now()))/3600000; if(ageH<=1)dq+=10; else if(ageH<=24)dq+=5; s+=Math.min(dq,100)*scoreWeights.quality;

      const comp = { explicit_optin:100, public_event_signup:80, business_public_record:75 }[lead.consentStatus]||20; s+=comp*scoreWeights.compliance;

      const bh=lead.behaviors||[]; let bs=0; if(bh.includes('event_attendance'))bs+=40; if(bh.includes('new_opening'))bs+=45; if(bh.includes('construction_permit'))bs+=35; if(bh.includes('website_visit'))bs+=25; if(bh.includes('form_download'))bs+=30; s+=Math.min(bs,100)*scoreWeights.behavior;

      const dist=lead.distance??15; let gs=50; if(dist<=5)gs=100; else if(dist<=10)gs=80; else if(dist<=25)gs=60; s+=gs*scoreWeights.geo;
      return Math.round(Math.min(s,100));
    }

    function priorityFromScore(s){ return s>=80?'High': s>=60?'Medium':'Low'; }

    // =====================
    // API layer
    // =====================
    async function fetchConfig(){
      try{
        const r=await fetch('/.netlify/functions/config');
        if(!r.ok) throw new Error('config not reachable');
        const j=await r.json();
        state.apiStatus=j; state.apiStatus.ok=true;
        const keys = ['places','eventbrite','ticketmaster','seatgeek','yelp'];
        state.connectedCount = keys.filter(k=>!!j[k]).length + 2; // +2 for LA public datasets
      }catch(e){ state.demo=true; pushNotice('info','Demo mode active (config not reachable).'); }
    }

    async function callFn(endpoint, params={}){
      const qs = new URLSearchParams({ region: state.region, ...params }).toString();
      const url = '/.netlify/functions/'+endpoint+'?'+qs;
      try{
        const r = await fetch(url);
        const j = await r.json();
        return j.ok? (j.items||[]) : [];
      }catch{ return []; }
    }

    async function runScan(){
      state.isScanning=true; state.items=[]; render();

      // In demo or if no functions, just return demo set
      if(state.demo){
        await new Promise(r=>setTimeout(r,900));
        const demo = [
          {id:'d1', name:'Small Business Growth Summit', apiSource:'demo', source:'Demo', location:`${state.region}, CA`, triggers:['event_attendance','business_formation'], consentStatus:'public_event_signup', behaviors:['event_attendance'], distance:8, capturedAt:new Date().toISOString(), contact:{email:'organizer@businesssummit.com'}, venue:'Convention Center', url:'#'},
          {id:'d2', name:`${state.region} Professional Services`, apiSource:'demo', source:'Demo', location:`${state.region}, CA`, triggers:['business_formation'], consentStatus:'business_public_record', behaviors:['website_visit'], distance:6, capturedAt:new Date().toISOString(), contact:{phone:'(714) 555-0123'}, extra:{naics:'Professional Services'}}
        ];
        state.items = demo.map(x=>({ ...x, score:calculateScore(x), priority:priorityFromScore(calculateScore(x)) }));
        state.isScanning=false; pushNotice('success',`Found ${state.items.length} demo opportunities.`); render(); return;
      }

      const status = state.apiStatus||{};
      const liveSources = API_SOURCES.filter(s=>!s.needsKey || status[s.id]);

      const promises = [
        ...liveSources.map(s=> callFn(s.endpoint)),
        ...CSV_SOURCES.map(([url,label]) => callFn('sheet-import',{ url, label }))
      ];

      const results = await Promise.allSettled(promises);
      const flattened = results.flatMap((res,i)=> res.status==='fulfilled'? res.value : []);
      let merged = dedupe(flattened);

      // Score + priority
      merged = merged.map(it=>{ const sc=calculateScore(it); return { ...it, score:sc, priority:priorityFromScore(sc) }; });

      state.items = merged.sort((a,b)=> b.score-a.score);
      state.isScanning=false;
      pushNotice('success',`Found ${state.items.length} opportunities from ${liveSources.length+CSV_SOURCES.length} sources.`);
      render();
    }

    // =====================
    // UI builders
    // =====================
    function header(){
      const connected = state.connectedCount;
      return `
        <header class="sticky top-0 z-30">
          <div class="glass shadow-soft border-b border-white/40">
            <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-xl bg-gradient-to-br from-brand-500 to-indigo-600"></div>
                <div>
                  <h1 class="text-lg md:text-xl font-semibold text-ink-900">${CONFIG.APP_NAME}</h1>
                  <p class="text-ink-500 text-xs">for ${CONFIG.AGENT_NAME}</p>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <div class="hidden md:flex items-center gap-2 text-xs">
                  <span class="badge" style="color:#0f766e;background:#ecfdf5;border-color:#99f6e4">${connected} sources</span>
                  ${state.demo? '<span class="badge" style="color:#7c3aed;background:#f3e8ff;border-color:#d8b4fe">Demo</span>':''}
                </div>
                <button id="scanBtn" class="btn btn-cta">${state.isScanning?'Scanning…':'Scan '+state.region}</button>
                <button id="exportBtn" class="btn btn-primary" ${state.items.length? '':'disabled'}>Export CSV</button>
              </div>
            </div>
          </div>
        </header>`;
    }

    function notices(){
      if(!state.notices.length) return '';
      return `<div class="max-w-7xl mx-auto px-6 mt-4 space-y-2">${state.notices.map(n=>`
        <div class="card px-4 py-3 border ${n.type==='success'?'border-green-200 bg-green-50':n.type==='info'?'border-blue-200 bg-blue-50':n.type==='warn'?'border-yellow-200 bg-yellow-50':'border-red-200 bg-red-50'}">
          <div class="flex justify-between items-center text-sm"><span>${n.msg}</span><span class="text-ink-500 text-xs">${n.at.toLocaleTimeString()}</span></div>
        </div>`).join('')}</div>`;
    }

    function stats(){
      const high=state.items.filter(i=>i.priority==='High').length;
      const newBiz=state.items.filter(i=> (i.triggers||[]).some(t=>['new_registration','public_record','new_business'].includes(t))).length;
      return `<section class="max-w-7xl mx-auto px-6 mt-6">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          ${statCard('🎯','Total Opportunities', state.items.length)}
          ${statCard('🔥','High Priority', high)}
          ${statCard('🆕','New Businesses', newBiz)}
          ${statCard('🗄️','Sources', state.connectedCount + CSV_SOURCES.length)}
        </div>
      </section>`;
    }

    const statCard=(emoji,label,val)=>`<div class="card p-5"><div class="flex items-center gap-3"><div class="text-2xl">${emoji}</div><div><div class="text-2xl font-semibold">${val}</div><div class="text-ink-500 text-sm">${label}</div></div></div></div>`;

    function controls(){
      const srcOpts = ['all',...API_SOURCES.map(s=>s.id),'csv','demo'].map(id=>`<option value="${id}">${id==='all'?'All Sources': id.toUpperCase()}</option>`).join('');
      return `<section class="max-w-7xl mx-auto px-6 mt-6">
        <div class="card p-4 flex flex-wrap items-center gap-3">
          <div class="flex items-center gap-2">
            <label class="text-sm text-ink-600">Region</label>
            <select id="regionSel" class="border rounded-lg px-3 py-2 text-sm">${REGIONS.map(r=>`<option ${r===state.region?'selected':''}>${r}</option>`).join('')}</select>
          </div>
          <div class="flex items-center gap-2">
            <label class="text-sm text-ink-600">Source</label>
            <select id="srcSel" class="border rounded-lg px-3 py-2 text-sm">${srcOpts}</select>
          </div>
          <div class="flex items-center gap-2">
            <label class="text-sm text-ink-600">Priority</label>
            <select id="prioSel" class="border rounded-lg px-3 py-2 text-sm"><option value="all">All</option><option>High</option><option>Medium</option><option>Low</option></select>
          </div>
          <div class="flex items-center gap-2">
            <label class="text-sm text-ink-600">Sort</label>
            <select id="sortSel" class="border rounded-lg px-3 py-2 text-sm"><option value="score_desc">Score</option><option value="name_asc">Name</option><option value="date_desc">Date</option></select>
          </div>
          <div class="flex items-center gap-2 grow">
            <input id="searchInput" placeholder="Search names, venues…" class="w-full border rounded-lg px-3 py-2 text-sm" />
          </div>
          <div class="flex items-center gap-2">
            <button id="addCsvBtn" class="btn border border-ink-200">+ CSV Source</button>
          </div>
        </div>
      </section>`;
    }

    function list(){
      let items=[...state.items];
      const f = state.filters; const q=(f.search||'').toLowerCase();
      if(f.source!=='all') items=items.filter(i=>i.apiSource===f.source || (f.source==='csv' && i.apiSource==='csv') || (f.source==='demo' && i.apiSource==='demo'));
      if(f.priority!=='all') items=items.filter(i=>i.priority===f.priority);
      if(q) items=items.filter(i=> (i.name||'').toLowerCase().includes(q) || (i.venue||'').toLowerCase().includes(q));
      if(f.sort==='name_asc') items.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
      if(f.sort==='date_desc') items.sort((a,b)=> new Date(b.capturedAt)-new Date(a.capturedAt));
      if(f.sort==='score_desc') items.sort((a,b)=> b.score-a.score);

      if(!items.length){
        return `<section class="max-w-7xl mx-auto px-6 mt-6">
          <div class="card p-12 text-center">
            <div class="text-5xl text-ink-300 mb-3">🎯</div>
            <div class="text-lg font-semibold">No results</div>
            <div class="text-ink-500">Try scanning, loosening filters, or adding a CSV source.</div>
            <div class="mt-5"><button id="scanEmpty" class="btn btn-cta">Scan ${state.region}</button></div>
          </div>
        </section>`;
      }

      return `<section class="max-w-7xl mx-auto px-6 mt-6 space-y-4">${items.map(card).join('')}</section>`;
    }

    const chip = (txt, tone='gray') => `<span class="badge ${tone==='red'?'text-red-700 border-red-200 bg-red-50': tone==='green'?'text-emerald-700 border-emerald-200 bg-emerald-50':'text-ink-600 border-ink-200 bg-ink-50'}">${txt}</span>`;

    function card(o){
      const scoreTone = o.score>=80?'green': o.score>=60?'':'gray';
      const priorityTone = o.priority==='High'?'red': o.priority==='Medium'?'':'gray';
      const contact = o.contact?.email || o.contact?.phone || o.url || o.contact?.website;
      return `<article class="card p-6 hover:shadow-soft transition-shadow">
        <div class="flex items-start justify-between gap-6">
          <div class="min-w-0 grow">
            <div class="flex flex-wrap items-center gap-2 mb-2">
              <h3 class="text-lg font-semibold text-ink-900 truncate">${o.name||'—'}</h3>
              ${chip(o.priority, priorityTone)}
              ${chip(o.source||o.apiSource?.toUpperCase()||'Source')}
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 text-sm">
              <div>
                <div class="text-ink-500">Contact</div>
                <div class="font-medium truncate">${o.contact?.phone||o.contact?.email||'N/A'}</div>
              </div>
              <div>
                <div class="text-ink-500">Location</div>
                <div class="font-medium truncate">${o.location||''}</div>
              </div>
              <div>
                <div class="text-ink-500">Captured</div>
                <div class="font-medium">${fmtDate(o.capturedAt||Date.now())}</div>
              </div>
              ${o.extra?.naics? `<div><div class="text-ink-500">Industry</div><div class="font-medium truncate">${o.extra.naics}</div></div>`:''}
              ${o.venue? `<div><div class="text-ink-500">Venue</div><div class="font-medium truncate">${o.venue}</div></div>`:''}
            </div>
            <div class="flex flex-wrap gap-2 mt-4">
              ${o.contact?.email? `<a class="btn border" href="mailto:${o.contact.email}">Email</a>`:''}
              ${o.contact?.phone? `<a class="btn border" href="tel:${o.contact.phone}">Call</a>`:''}
              ${contact? `<a class="btn border" href="${o.url||o.contact?.website||'#'}" target="_blank" rel="noopener">Details</a>`:''}
              <a class="btn border" target="_blank" rel="noopener" href="https://www.google.com/search?q=${encodeURIComponent((o.name||'')+' '+(o.location||''))}">Research</a>
            </div>
          </div>
          <div class="text-center shrink-0">
            <div class="px-4 py-2 rounded-xl border ${scoreTone==='green'?'border-emerald-200 bg-emerald-50 text-emerald-700': scoreTone===''?'border-indigo-200 bg-indigo-50 text-indigo-700':'border-ink-200 bg-ink-50 text-ink-700'} text-2xl font-bold">${o.score??'—'}</div>
            <div class="text-xs text-ink-500 mt-1">AI Score</div>
          </div>
        </div>
      </article>`;
    }

    function footer(){
      return `<footer class="max-w-7xl mx-auto px-6 py-10 text-center text-xs text-ink-500">© ${new Date().getFullYear()} New York Life Insurance Company. For informational purposes only; not an offer or solicitation. ${CONFIG.AGENT_NAME} — ${CONFIG.AGENT_LICENSE}. Contact: ${CONFIG.AGENT_EMAIL}.</footer>`;
    }

    function settingsModal(){
      return `<div id="settingsModal" class="fixed inset-0 hidden items-center justify-center">
        <div class="absolute inset-0 bg-black/40"></div>
        <div class="relative card w-full max-w-xl p-6 z-10">
          <h3 class="text-lg font-semibold mb-2">Add CSV Source</h3>
          <p class="text-sm text-ink-600 mb-4">Paste a <strong>published CSV</strong> link (e.g., Google Sheets → Publish to web → CSV). This is great for LA County FBN, CA SOS exports, or OC deeds.</p>
          <div class="space-y-3">
            <input id="csvUrl" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="https://.../pub?output=csv" />
            <input id="csvLabel" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="Label (e.g., LA FBN)" />
          </div>
          <div class="mt-5 flex items-center justify-end gap-3">
            <button id="csvCancel" class="btn border">Cancel</button>
            <button id="csvSave" class="btn btn-cta">Add</button>
          </div>
        </div>
      </div>`;
    }

    // =====================
    // Render root
    // =====================
    function render(){
      const root = document.getElementById('app');
      root.innerHTML = header()+notices()+stats()+controls()+list()+footer()+settingsModal();

      // wire up
      $('#scanBtn')?.addEventListener('click', runScan);
      $('#exportBtn')?.addEventListener('click', exportCSV);
      $('#scanEmpty')?.addEventListener('click', runScan);
      $('#regionSel')?.addEventListener('change', (e)=>{ state.region=e.target.value; localStorage.setItem('region',state.region); $('#scanBtn').textContent = 'Scan '+state.region; });
      $('#srcSel')?.addEventListener('change',(e)=>{ state.filters.source=e.target.value; if(state.filters.source==='csv' && CSV_SOURCES.length===0) pushNotice('info','No CSVs configured. Add one with + CSV Source.'); render(); });
      $('#prioSel')?.addEventListener('change',(e)=>{ state.filters.priority=e.target.value; render(); });
      $('#sortSel')?.addEventListener('change',(e)=>{ state.filters.sort=e.target.value; render(); });
      $('#searchInput')?.addEventListener('input',(e)=>{ state.filters.search=e.target.value; render(); });
      $('#addCsvBtn')?.addEventListener('click', ()=>{ $('#settingsModal').classList.remove('hidden'); $('#settingsModal').classList.add('flex'); });
      $('#csvCancel')?.addEventListener('click', ()=>{ $('#settingsModal').classList.add('hidden'); $('#settingsModal').classList.remove('flex'); });
      $('#csvSave')?.addEventListener('click', ()=>{
        const url=$('#csvUrl').value.trim(); const label=$('#csvLabel').value.trim()||'CSV Import';
        if(!url){ pushNotice('warn','Please paste a CSV URL.'); return; }
        CSV_SOURCES.push([url,label]); pushNotice('success',`Added CSV: ${label}`);
        $('#settingsModal').classList.add('hidden'); $('#settingsModal').classList.remove('flex');
      });

      // Loading state visuals
      if(state.isScanning){
        $$('#app article.card, #scanBtn').forEach(n=>n.classList.add('skeleton'));
      }
    }

    // =====================
    // CSV export
    // =====================
    function csvEscape(v){ let s=String(v??''); if(s.includes('"')) s=s.replaceAll('"','""'); if(/[",\n]/.test(s)) s='"'+s+'"'; return s; }
    function exportCSV(){
      if(!state.items.length){ pushNotice('warn','No opportunities to export.'); return; }
      const rows = state.items.map(o=>({
        Name:o.name,Score:o.score,Source:o.source||o.apiSource,Location:o.location||'',Priority:o.priority||'',Email:o.contact?.email||'',Phone:o.contact?.phone||'',Compliance:o.consentStatus||'',Date:fmtDate(o.capturedAt||Date.now()),Venue:o.venue||'',URL:o.url||'',Categories:o.categories||'',Rating:o.rating||'',Reviews:o.reviewCount||'',Industry:o.extra?.naics||''
      }));
      const header = Object.keys(rows[0]).map(csvEscape).join(',');
      const body = rows.map(r=>Object.values(r).map(csvEscape).join(',')).join('\n');
      const blob = new Blob([header+'\n'+body],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`nyl-leads-${state.region.replaceAll(' ','-')}-${new Date().toISOString().slice(0,10)}.csv`; a.click(); URL.revokeObjectURL(url);
      pushNotice('success',`Exported ${rows.length} rows.`);
    }

    // Init
    render();
    fetchConfig().then(()=>{ /* ready */ });
  </script>
</body>
</html>
